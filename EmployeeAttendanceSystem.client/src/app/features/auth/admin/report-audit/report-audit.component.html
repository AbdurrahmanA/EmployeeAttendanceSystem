<div class="audit-container">
  <div class="report-header">
    <h2>Denetim Logları</h2>
    <p class="subtitle">Sistemdeki tüm eylemleri ve veri değişikliklerini izleyin.</p>
  </div>

  <div class="filters-card">
    <div class="inputs-grid">
      <div class="form-group">
        <label for="startDate">Başlangıç</label>
        <input id="startDate" name="startDate" type="date" [value]="startDate()"
          (change)="onFilterChange($event, startDate)">
      </div>

      <div class="form-group">
        <label for="endDate">Bitiş</label>
        <input id="endDate" name="endDate" type="date" [value]="endDate()" (change)="onFilterChange($event, endDate)">
      </div>

      <div class="form-group">
        <label for="userName">Kullanıcı (Ad/Email)</label>
        <input id="userName" name="userName" type="text" placeholder="Örn: admin" [value]="userName()"
          (input)="onFilterChange($event, userName)">
      </div>

      <div class="form-group">
        <label for="action">İşlem tipi</label>
        <select id="action" name="action" [value]="action()" (change)="onFilterChange($event, action)">
          <option value="">Tümü</option>
          <option value="Login">Giriş (Login)</option>
          <option value="Insert">Ekleme (Insert)</option>
          <option value="Update">Güncelleme (Update)</option>
          <option value="Delete">Silme (Delete)</option>
        </select>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn-filter" (click)="onFilter()" [disabled]="isLoading()">
        <i class="bi bi-search"></i>Ara
      </button>
      <button class="btn-download" (click)="downloadReport()" [disabled]="isLoading()">
        <i class="bi bi-file-earmark-arrow-down"></i> İndir
      </button>
    </div>
  </div>

  @if(errorMessage()) {
  <div class="alert error">{{errorMessage()}}</div>
  }

  @if (isLoading()) {
  <div class="loading">Yükleniyor...</div>
  }

  @if (!isLoading() && logs() && logs().length > 0) {
  <div class="table-responsive">
    <table class="audit-table">
      <thead>
        <tr>
          <th>Id</th>
          <th>Zaman</th>
          <th>Kullanıcı</th>
          <th>Kullanıcı ID</th>
          <th>İşlem</th>
          <th>Durum</th>
          <th>Varlık Tipi</th>
          <th>Varlık ID</th>
          <th>IP</th>
          <th>User Agent</th>
          <th>Hata</th>
          <th>Eski Değerler</th>
          <th>Yeni Değerler</th>
        </tr>
      </thead>
      <tbody>
        @for (log of logs(); track log.Id) {
        <tr>
          <td class="cell-id">{{log.Id}}</td>
          <td class="cell-time">{{log.Timestamp | date:'dd.MM.yyyy HH:mm:ss'}}</td>
          <td class="cell-user">{{log.UserName || 'Anonim'}}</td>
          <td class="cell-userid">{{log.UserId || '-'}}</td>
          <td class="cell-action">
            <span class="badge action" [class.api]="!log.EntityType" [class.db]="log.EntityType">
              {{log.Action}}
            </span>
          </td>
          <td class="cell-status">
            @if (log.Success) {
            <span class="badge success">Başarılı</span>
            } @else {
            <span class="badge danger">Hata</span>
            }
          </td>
          <td class="cell-entity">{{log.EntityType || '-'}}</td>
          <td class="cell-entityid">{{log.EntityId || '-'}}</td>
          <td class="cell-ip">{{log.IpAddress || '-'}}</td>
          <td class="cell-agent">
            <div class="text-truncate" [title]="log.UserAgent || '-'">
              {{log.UserAgent || '-'}}
            </div>
          </td>
          <td class="cell-error">{{log.ErrorMessage || '-'}}</td>
          <td class="cell-values">
            @if (log.OldValues) {
            <div class="json-container">
              <pre>{{log.OldValues}}</pre>
            </div>
            } @else {
            <span class="text-muted">-</span>
            }
          </td>
          <td class="cell-values">
            @if (log.NewValues) {
            <div class="json-container">
              <pre>{{log.NewValues}}</pre>
            </div>
            } @else {
            <span class="text-muted">-</span>
            }
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <div class="pagination">
    <button (click)="changePage(currentPage() - 1)" [disabled]="currentPage() === 1">
      <i class="bi bi-chevron-left"></i> Önceki
    </button>

    <span class="page-info">
      Sayfa <strong>{{currentPage()}}</strong> / {{totalPages()}}
      (Top. {{totalCount()}} kayıt)
    </span>

    <button (click)="changePage(currentPage() + 1)" [disabled]="currentPage() === totalPages()">
      Sonraki <i class="bi bi-chevron-right"></i>
    </button>
  </div>
  }

  @if (!isLoading() && (!logs() || logs().length === 0)) {
  <div class="empty">Kayıt bulunamadı.</div>
  }
</div>